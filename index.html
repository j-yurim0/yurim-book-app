<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ë…ì„œ ê¸°ë¡ì¥ (Cloud)</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ridibatang/1.0.0/ridibatang.min.css">
    
    <style>
        :root { --bg-color: #fdfbf7; --primary-color: #5d4037; --accent-color: #d84315; --font-main: 'Pretendard', sans-serif; --font-book: 'RIDIBatang', serif; }
        * { box-sizing: border-box; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: #333; margin: 0; padding: 0; max-width: 600px; margin: 0 auto; min-height: 100vh; padding-bottom: 90px; border-left: 1px solid #eee; border-right: 1px solid #eee; position: relative;}

        /* ë¡œê·¸ì¸ í™”ë©´ */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(93, 64, 55, 0.15); width: 100%; max-width: 400px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-auth-submit { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .auth-switch { margin-top: 20px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }

        #app-container { display: none; }

        /* í—¤ë” & ì´ˆê¸°í™” ë²„íŠ¼ ë¬¶ìŒ */
        header { padding: 20px; text-align: center; position: relative; }
        h2 { font-family: var(--font-book); color: var(--primary-color); margin: 0; font-size: 1.5rem; }
        .header-left-btns { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 5px; align-items: flex-start;}
        .btn-header { font-size: 0.8rem; color: #999; background: none; border: none; cursor: pointer; text-decoration: underline; padding: 0; }
        .btn-logout { position: absolute; top: 20px; right: 20px; font-size: 0.8rem; color: #999; background: none; border: none; cursor: pointer; text-decoration: underline; padding: 0; }

        /* ìŠ¤íƒ€ì¼ */
        .home-search-box { margin: 0 20px 20px; background: white; border: 2px solid var(--primary-color); border-radius: 12px; padding: 10px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(93, 64, 55, 0.1); }
        .search-input { flex: 1; border: none; outline: none; font-size: 1rem; padding: 5px; }
        .btn-camera { font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 5px; }
        .tracker-box { background: white; padding: 20px; margin: 0 20px 25px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .streak-info { font-size: 1.1rem; font-weight: bold; color: var(--accent-color); margin-bottom: 15px; }
        .week-circles { display: flex; justify-content: space-between; }
        .day-circle { width: 38px; height: 38px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #aaa; transition: 0.3s; }
        .day-circle.active { background: var(--accent-color); color: white; font-weight: bold; transform: scale(1.1); }
        .day-label { font-size: 0.7rem; color: #999; margin-top: 5px; }
        .section-title { padding: 0 20px; margin-bottom: 10px; font-weight: bold; color: var(--primary-color); font-size: 1.1rem; display: flex; justify-content: space-between; align-items: flex-end; }
        .h-scroll-container { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 20px; scroll-behavior: smooth; flex-wrap: nowrap; }
        .h-scroll-container::-webkit-scrollbar { display: none; }
        .reading-card { min-width: 280px; flex: 0 0 auto; background: white; padding: 15px; border-radius: 12px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
        .reading-cover { width: 60px; height: 90px; object-fit: cover; border-radius: 4px; background: #eee; flex-shrink: 0; }
        .progress-bar { background: #eee; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { background: var(--accent-color); height: 100%; width: 0%; transition: width 0.5s; }
        .btn-round { padding: 6px 12px; font-size: 0.8rem; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-record { background: #f0f0f0; color: #333; }
        .btn-finish { background: var(--accent-color); color: white; }
        .btn-edit { background: none; border: 1px solid #ddd; color: #888; margin-left: 5px; }
        .btn-card-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #999; font-size: 1.2rem; cursor: pointer; line-height: 1; }
        .mini-card { min-width: 90px; flex: 0 0 auto; text-align: center; position: relative; }
        .mini-cover { width: 90px; height: 130px; object-fit: cover; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .mini-title { font-size: 0.8rem; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-mini-del { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; font-size: 0.8rem; }
        
        .shelf-wrapper { margin: 0 20px; background: #d7ccc8; padding: 40px 20px 20px; border-radius: 5px; box-shadow: inset 2px 2px 10px rgba(0,0,0,0.1); }
        .shelf-flex-container { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 2px; width: 100%; border-bottom: 20px solid #5d4037; padding-bottom: 0; min-height: 180px; }
        .spine { writing-mode: vertical-rl; text-orientation: mixed; color: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); border-radius: 3px 3px 0 0; padding: 10px 4px; font-size: 0.8rem; box-shadow: 2px 0 4px rgba(0,0,0,0.2); text-align: left; font-family: var(--font-book); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.5; margin-bottom: 0; transition: transform 0.2s; cursor: pointer; }
        .spine:hover { transform: translateY(-10px); z-index: 10; }
        
        .quote-main-view { padding: 0 20px; }
        .quote-list-view { display: none; }
        .big-menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        .big-card-btn { padding: 30px 20px; border-radius: 15px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: transform 0.2s; text-align: center; color: white; }
        .big-card-btn:hover { transform: translateY(-3px); }
        .btn-treasure { background: linear-gradient(135deg, #5d4037, #4e342e); }
        .btn-list { background: linear-gradient(135deg, #8d6e63, #6d4c41); }
        .big-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .big-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .big-desc { font-size: 0.85rem; opacity: 0.9; }
        .btn-back-list { background: white; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; color: #555; margin-bottom: 15px;}
        .quote-list-container { margin-top: 10px; }
        .quote-item { background: white; padding: 20px; margin-bottom: 15px; border-radius: 12px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;}
        
        .rank-box { background:white; padding:20px; border-radius:15px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .rank-title { margin:0 0 15px; font-size: 1.1rem; color: var(--primary-color); font-weight: bold; }
        .rank-row { margin-bottom: 15px; }
        .rank-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
        .rank-bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .rank-bar-fill { background: var(--accent-color); height: 100%; border-radius: 5px; width: 0; transition: width 1s; }
        
        .full-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2000; overflow-y: auto; }
        .search-header { position: sticky; top: 0; background: var(--bg-color); padding: 15px; display: flex; gap: 10px; border-bottom: 1px solid #ddd; z-index: 10; }
        .search-header input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        .result-item { display: flex; gap: 15px; background: white; padding: 15px; margin: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .result-actions button { margin-right: 5px; padding: 6px 12px; font-size: 0.8rem; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { text-align: center; cursor: pointer; color: #aaa; flex: 1; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #eee; margin: 0 20px; }
        .cal-day { background: white; min-height: 100px; position: relative; display: flex; }
        .cal-split { flex: 1; height: 100%; overflow: hidden; position: relative; border-right: 1px solid white; }
        .cal-split:last-child { border-right: none; }
        .cal-img { width: 100%; height: 100%; object-fit: cover; }
        .cal-num { position: absolute; top: 3px; left: 3px; font-size: 0.75rem; font-weight: bold; background: rgba(255,255,255,0.8); padding: 0 4px; border-radius: 3px; z-index: 5;}
        
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 0 20px 20px; }
        .gallery-item { text-align: center; position: relative; }
        .gallery-item img { width: 100%; height: 140px; object-fit: cover; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); margin-bottom: 5px; cursor: pointer; }
        .gallery-title { font-weight: bold; font-size: 0.85rem; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .gallery-author { font-size: 0.75rem; color: #888; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .gallery-date { font-size: 0.7rem; color: var(--accent-color); margin-top: 2px; }
        .btn-gal-edit { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); color: #333; width: 25px; height: 25px; border-radius: 50%; border: none; cursor: pointer; font-size: 0.8rem; line-height: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; max-height: 80vh; overflow-y: auto;}
        
        .mystery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; width: 100%; padding: 10px;}
        .mystery-card { background: #fffaf0; padding: 20px; border-radius: 12px; cursor: pointer; font-family: 'RIDIBatang'; font-size: 0.9rem; line-height: 1.5; color: #444; height: 140px; overflow: hidden; position: relative; box-shadow: 0 3px 8px rgba(0,0,0,0.08); border: 1px solid #eee; transition: 0.3s; display: flex; align-items: center; justify-content: center; text-align: center; }
        .mystery-card:hover { transform: translateY(-5px); box-shadow: 0 5px 12px rgba(0,0,0,0.12); background: #fff; }
        .mystery-card-text { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .quote-detail-cover { width: 100px; height: 150px; object-fit: cover; border-radius: 5px; box-shadow: 2px 2px 8px rgba(0,0,0,0.15); margin: 0 auto 15px; display: block;}
        .quote-detail-text { font-family: 'RIDIBatang'; font-size: 1.1rem; line-height: 1.6; margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
        .placeholder-cover { width: 100%; height: 100%; background: #eee; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.8rem; color: #555; padding: 5px; font-weight: bold; border-radius: 4px; }
        .btn-delete-red { background: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; padding: 10px; border-radius: 5px; width: 100%; margin-top: 20px; cursor: pointer; font-weight: bold; }
        #scanner-container { width: 100%; height: 250px; background: black; overflow: hidden; position: relative; }

        /* ë‹¨ì–´ì¥ íƒ­ ì „ìš© ìŠ¤íƒ€ì¼ */
        .voca-input-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin: 0 20px 20px; }
        .voca-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: var(--font-main); }
        .btn-dict-search { width: 100%; padding: 12px; background: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .voca-filter { display: flex; justify-content: flex-end; padding: 0 20px; margin-bottom: 10px; }
        .voca-filter select { padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; outline: none; }
        .voca-card { background: white; padding: 15px 20px; margin: 0 20px 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 4px solid #8d6e63; }
        .voca-word { font-weight: bold; font-size: 1.1rem; color: var(--primary-color); margin-bottom: 5px; }
        .voca-meaning { font-size: 0.9rem; color: #555; line-height: 1.4; }
        .btn-voca-del { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .btn-voca-del:hover { color: red; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="margin-bottom:20px;">ğŸ“š ë…ì„œ ê¸°ë¡ì¥</h2>
            <div id="login-form">
                <input type="email" id="login-email" class="auth-input" placeholder="ì´ë©”ì¼">
                <input type="password" id="login-pw" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button class="btn-auth-submit" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                <div class="auth-switch" onclick="switchAuthMode('signup')">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
            </div>
            <div id="signup-form" style="display:none;">
                <input type="email" id="signup-email" class="auth-input" placeholder="ì´ë©”ì¼ ì…ë ¥">
                <input type="password" id="signup-pw" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (6ìë¦¬ ì´ìƒ)">
                <button class="btn-auth-submit" onclick="handleSignup()">íšŒì›ê°€ì…</button>
                <div class="auth-switch" onclick="switchAuthMode('login')">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-left-btns">
                <button class="btn-header" onclick="resetToday()">ì˜¤ëŠ˜ ì´ˆê¸°í™”</button>
                <button class="btn-header" onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
            <h2>My Reading Log</h2>
            <button class="btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </header>

        <div id="tab-home" class="tab-content active">
            <div class="home-search-box">
                <span style="font-size:1.2rem;">ğŸ”</span>
                <input type="text" class="search-input" placeholder="ì±… ê²€ìƒ‰ ë˜ëŠ” ë°”ì½”ë“œ" onclick="openSearch()" readonly>
                <button class="btn-camera" onclick="openScanner()">ğŸ“·</button>
            </div>
            <div class="tracker-box">
                <div class="streak-info" id="streakDisplay">ğŸ”¥ 0ì¼ ì—°ì† ë…ì„œ ì¤‘</div>
                <div class="week-circles" id="weekCircles"></div>
            </div>
            <div class="section-title"><span>ğŸ“– ì½ê³  ìˆëŠ” ì±…</span></div>
            <div id="readingList" class="h-scroll-container"></div>
            <div style="height: 20px;"></div>
            <div class="section-title"><span>â­ï¸ ìœ„ì‹œë¦¬ìŠ¤íŠ¸</span><span style="font-size:0.8rem; color:#999;" id="wishCount">0ê¶Œ</span></div>
            <div id="wishList" class="h-scroll-container"></div>
            <div style="height: 20px;"></div>
            <div class="section-title"><span>ğŸ—“ ì½ì„ ì˜ˆì •</span><span style="font-size:0.8rem; color:#999;" id="toreadCount">0ê¶Œ</span></div>
            <div id="toreadList" class="h-scroll-container"></div>
            <div style="height: 30px;"></div>
            <div class="section-title">ğŸ“š ë‚´ ì„œì¬ (ì™„ë…)</div>
            <div class="shelf-wrapper">
                <div class="shelf-flex-container" id="bookShelf"></div>
            </div>
        </div>

        <div id="tab-calendar" class="tab-content">
            <div style="display:flex; justify-content:space-between; padding:0 20px 10px; font-weight:bold; font-size:1.2rem;">
                <span onclick="changeMonth(-1)" style="cursor:pointer">â—€</span>
                <span id="calTitle"></span>
                <span onclick="changeMonth(1)" style="cursor:pointer">â–¶</span>
            </div>
            <div class="cal-grid" id="calGrid"></div>
            <div class="section-title" style="margin-top:30px;">ğŸ–¼ ì™„ë…í•œ ì±…ë“¤ (ìˆ˜ì •)</div>
            <div class="gallery-grid" id="galleryGrid"></div>
        </div>

        <div id="tab-quotes" class="tab-content">
            <div id="quoteMainView" class="quote-main-view">
                <div style="height:20px;"></div>
                <div class="big-menu-grid">
                    <div class="big-card-btn btn-treasure" onclick="openMysteryModal()">
                        <div class="big-icon">ğŸ</div>
                        <div class="big-title">ë¬¸ì¥ ë³´ë¬¼ìƒì ì—´ê¸°</div>
                        <div class="big-desc">ëœë¤ìœ¼ë¡œ ë¬¸ì¥ì„ ë½‘ì•„ë³´ì„¸ìš”!</div>
                    </div>
                    <div class="big-card-btn btn-list" onclick="toggleQuoteView('list')">
                        <div class="big-icon">ğŸ“œ</div>
                        <div class="big-title">ì „ì²´ ë¬¸ì¥ ë³´ê¸°</div>
                        <div class="big-desc">ì €ì¥ëœ ëª¨ë“  ë¬¸ì¥ì„ í™•ì¸í•˜ì„¸ìš”</div>
                    </div>
                </div>
                <button onclick="openQuoteModal()" style="width:100%; font-size:0.9rem; background:white; color:#5d4037; border:1px solid #5d4037; padding:15px; border-radius:12px; cursor:pointer; font-weight:bold;">+ ë¬¸ì¥ ì§ì ‘ ì¶”ê°€í•˜ê¸°</button>
            </div>
            <div id="quoteListView" class="quote-list-view">
                <div style="padding:20px 20px 0;">
                    <button class="btn-back-list" onclick="toggleQuoteView('main')">â†© ë’¤ë¡œê°€ê¸°</button>
                </div>
                <div class="quote-list-container" id="quoteList"></div>
            </div>
        </div>

        <div id="tab-voca" class="tab-content">
            <div class="section-title" style="margin-top:10px;">
                <span>ğŸ”– ìƒˆ ë‹¨ì–´ ì¶”ê°€</span>
            </div>
            <div class="voca-input-box">
                <input type="text" id="vocaWordInput" class="voca-input" placeholder="ëª¨ë¥´ëŠ” ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button id="btnDictSearch" class="btn-dict-search" onclick="searchDict()"><span>ğŸ¤–</span> AI ìë™ ëœ» ì°¾ê¸°</button>
                <textarea id="vocaMeaningInput" class="voca-input" rows="3" placeholder="ëœ»ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ë„ ìˆì–´ìš”."></textarea>
                <button onclick="addVoca()" style="width:100%; padding:12px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ë‹¨ì–´ì¥ì— ì €ì¥</button>
            </div>

            <div class="section-title">
                <span>ğŸ“š ë‚´ ë‹¨ì–´ì¥</span>
            </div>
            <div class="voca-filter">
                <select id="vocaSortSelect" onchange="renderVoca()">
                    <option value="latest">ìµœì‹ ìˆœ</option>
                    <option value="abc">ê°€ë‚˜ë‹¤ìˆœ</option>
                </select>
            </div>
            <div id="vocaListContainer" style="padding-bottom: 30px;"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <div style="padding:20px;">
                <div class="rank-box"><div class="rank-title">ğŸ† ì„ í˜¸ ë¶„ì•¼ TOP 5</div><div id="rankCategory"></div></div>
                <div class="rank-box"><div class="rank-title">âœï¸ ìµœì•  ì‘ê°€ TOP 5</div><div id="rankAuthor"></div></div>
                <div class="rank-box"><div class="rank-title">ğŸ¢ ì„ í˜¸ ì¶œíŒì‚¬ TOP 5</div><div id="rankPublisher"></div></div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home', this)"><span>ğŸ </span><div style="font-size:0.7rem">í™ˆ</div></div>
            <div class="nav-item" onclick="switchTab('calendar', this)"><span>ğŸ“…</span><div style="font-size:0.7rem">ë‹¬ë ¥</div></div>
            <div class="nav-item" onclick="switchTab('quotes', this)"><span>âœï¸</span><div style="font-size:0.7rem">ë¬¸ì¥</div></div>
            <div class="nav-item" onclick="switchTab('voca', this)"><span>ğŸ”–</span><div style="font-size:0.7rem">ë‹¨ì–´</div></div>
            <div class="nav-item" onclick="switchTab('stats', this)"><span>ğŸ“Š</span><div style="font-size:0.7rem">ë­í‚¹</div></div>
        </div>
    </div>

    <div id="searchModal" class="full-modal">
        <div class="search-header">
            <button onclick="document.getElementById('searchModal').style.display='none'" style="font-size:1.5rem; background:none; border:none;">&larr;</button>
            <input type="text" id="searchInput" placeholder="ì±… ì œëª©, ì‘ê°€, ë°”ì½”ë“œ ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') searchBooks()">
            <button onclick="searchBooks()" style="background:var(--accent-color); color:white; border:none; padding:0 15px; border-radius:5px;">ê²€ìƒ‰</button>
        </div>
        <div id="searchResultList"></div>
    </div>

    <div id="scannerModal" class="modal-overlay">
        <div class="modal-box" style="max-width:500px;">
            <h3>ğŸ“· ë°”ì½”ë“œ ìŠ¤ìº”</h3>
            <div id="scanner-container"></div>
            <button onclick="closeScanner()" style="padding:10px; background:#eee; border:none; border-radius:5px; width:100%; margin-top:10px;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="dateModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="dateModalTitle">ë‚ ì§œ ì„ íƒ</h3>
            <label style="font-size:0.8rem; color:#666;">ë‚ ì§œ</label>
            <input type="date" id="dateInput" style="padding:10px; border:1px solid #ddd; border-radius:5px; font-size:1rem;">
            
            <div id="pageInputWrap" style="display:none;">
                <label style="font-size:0.8rem; color:#666; margin-top:10px; display:block;">ì½ì€ í˜ì´ì§€</label>
                <input type="number" id="pageInput" placeholder="í˜ì´ì§€ ìˆ˜" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>

            <textarea id="bookComment" rows="3" placeholder="ì±…ì— ëŒ€í•œ ììœ ë¡œìš´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”. (ì„ íƒ ì‚¬í•­)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; margin-top:10px; display:none; font-family:var(--font-main); font-size:0.9rem; resize:none;"></textarea>

            <div id="extraEditWrap" style="display:none; margin-top:10px;">
                <label style="font-size:0.8rem; color:#666; display:block;">ì¶œíŒì‚¬ (ë­í‚¹ ë°˜ì˜)</label>
                <input type="text" id="editPublisher" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#666; display:block;">ì¹´í…Œê³ ë¦¬ (ë­í‚¹ ë°˜ì˜)</label>
                <input type="text" id="editCategory" placeholder="ì†Œì„¤, ì—ì„¸ì´, ìê¸°ê³„ë°œ ë“±" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('dateModal').style.display='none'" style="flex:1; padding:10px; background:#eee; border:none; border-radius:5px;">ì·¨ì†Œ</button>
                <button onclick="confirmDateAction()" style="flex:1; padding:10px; background:var(--primary-color); color:white; border:none; border-radius:5px;">í™•ì¸</button>
            </div>
            <button id="btnDeleteBook" class="btn-delete-red" style="display:none;" onclick="deleteCurrentBook()">ğŸ—‘ï¸ ì´ ì±… ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <div id="bookDetailModal" class="modal-overlay" style="z-index: 3100;">
        <div class="modal-box" style="text-align:center;">
            <div id="bdCoverContainer"></div>
            <h3 id="bdTitle" style="margin:0;">ì±… ì œëª©</h3>
            <div id="bdInfo" style="font-size:0.85rem; color:#666; margin-top:5px;">ì‘ê°€ | ì¶œíŒì‚¬</div>
            <div style="font-size:0.8rem; color:var(--accent-color); margin-top:5px;" id="bdDate">ì™„ë…ì¼</div>
            
            <div id="bdCommentWrap" style="margin-top:15px; text-align:left; background:#f9f9f9; padding:15px; border-radius:8px; display:none;">
                <div style="font-size:0.8rem; color:#888; margin-bottom:5px; font-weight:bold;">ë‚˜ì˜ ì½”ë©˜íŠ¸</div>
                <div id="bdComment" style="font-size:0.95rem; line-height:1.5; white-space:pre-wrap; color:#444; font-family:var(--font-book);"></div>
            </div>
            
            <button onclick="document.getElementById('bookDetailModal').style.display='none'" style="padding:10px; background:var(--primary-color); color:white; border:none; border-radius:5px; margin-top:20px; width:100%;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="quoteModal" class="modal-overlay">
        <div class="modal-box">
            <h3>ë¬¸ì¥ ì¶”ê°€</h3>
            <select id="qBook" style="padding:8px; border:1px solid #ccc; border-radius:5px; font-family:var(--font-main);"></select>
            <input type="number" id="qPage" placeholder="í˜ì´ì§€ (ì„ íƒ)" style="padding:8px; border:1px solid #ccc; border-radius:5px;">
            <textarea id="qText" rows="4" placeholder="ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”" style="padding:8px; border:1px solid #ccc; border-radius:5px; font-family:var(--font-main);"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="document.getElementById('quoteModal').style.display='none'" style="flex:1; padding:10px; background:#eee; border:none; border-radius:5px;">ì·¨ì†Œ</button>
                <button onclick="saveQuote()" style="flex:1; padding:10px; background:var(--primary-color); color:white; border:none; border-radius:5px;">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="mysteryModal" class="modal-overlay">
        <div class="modal-box" style="max-width:600px; background: #fdfbf7;">
            <h3 style="margin-top:0; text-align:center;">ğŸ“œ ë¬¸ì¥ ë³´ë¬¼ìƒì</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:15px; text-align:center;">êµ¬ì ˆì„ í´ë¦­í•´ ì¶œì²˜ë¥¼ í™•ì¸í•˜ì„¸ìš”!</p>
            <div class="mystery-grid" id="mysteryGrid" style="max-height: 60vh; overflow-y: auto;"></div>
            <button onclick="document.getElementById('mysteryModal').style.display='none'" style="padding:10px; background:#eee; border:none; border-radius:5px; margin-top:15px; width:100%;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="quoteDetailModal" class="modal-overlay" style="z-index: 3100;">
        <div class="modal-box" style="text-align:center;">
            <div id="qdCoverContainer"></div>
            <h3 id="qdTitle" style="margin:0;">ì±… ì œëª©</h3>
            <div id="qdAuthor" style="font-size:0.9rem; color:#666; margin-top:5px;">ì‘ê°€</div>
            <div class="quote-detail-text">"<span id="qdText">ë¬¸ì¥ ë‚´ìš©</span>"</div>
            <div style="font-size:0.9rem; color:#666;">- p.<span id="qdPage"></span> -</div>
            <button onclick="document.getElementById('quoteDetailModal').style.display='none'" style="padding:10px; background:var(--primary-color); color:white; border:none; border-radius:5px; margin-top:20px; width:100%;">í™•ì¸</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfalVdpUZ0YaFjt6_gaOBvq1TeIzb40eg",
            authDomain: "book-yum-5babd.firebaseapp.com",
            projectId: "book-yum-5babd",
            storageBucket: "book-yum-5babd.firebasestorage.app",
            messagingSenderId: "131924542195",
            appId: "1:131924542195:web:a6f959517f002c0ca86d86"
        };

        let dbRef = null;
        let auth = null;

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    dbRef = doc(firestore, "users", user.uid);
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    loadData();
                } else {
                    document.getElementById('auth-screen').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                }
            });

            window.handleLogin = async () => {
                const email = document.getElementById('login-email').value;
                const pw = document.getElementById('login-pw').value;
                try { await signInWithEmailAndPassword(auth, email, pw); } 
                catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); }
            };

            window.handleSignup = async () => {
                const email = document.getElementById('signup-email').value;
                const pw = document.getElementById('signup-pw').value;
                if(pw.length < 6) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                try {
                    await createUserWithEmailAndPassword(auth, email, pw);
                    alert("íšŒì›ê°€ì… ì„±ê³µ! í™˜ì˜í•©ë‹ˆë‹¤.");
                } catch(e) { alert("ê°€ì… ì‹¤íŒ¨: ì´ë¯¸ ìˆëŠ” ê³„ì •ì´ê±°ë‚˜ ì´ë©”ì¼ í˜•ì‹ì´ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
            };

            window.handleLogout = async () => {
                if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await signOut(auth);
                    window.db = { reading: [], library: [], wish: [], toread: [], quotes: [], logs: [], voca: [] };
                }
            };

        } catch(e) {
            alert("íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
        }

        window.API_KEY = 'AIzaSyB9SjdXwflGS-oUZfmaVGE1vWhBEahY4L0';
        window.db = { reading: [], library: [], wish: [], toread: [], quotes: [], logs: [], voca: [] };
        window.tempBookData = null;
        
        async function loadData() {
            if(dbRef) {
                try {
                    const docSnap = await getDoc(dbRef);
                    if (docSnap.exists()) {
                        window.db = docSnap.data();
                        if(!window.db.logs) window.db.logs = [];
                        if(!window.db.voca) window.db.voca = [];
                        if(window.db.library) window.db.library.sort((a,b) => new Date(a.date) - new Date(b.date));
                    } else {
                        await setDoc(dbRef, window.db);
                    }
                } catch(e) { console.error(e); }
            }
            if(window.initUI) window.initUI();
        }

        window.save = async function() {
            if(dbRef) {
                try { await setDoc(dbRef, window.db); } catch(e) { console.error(e); }
            }
        }
    </script>

    <script>
        // ================= UI ë¡œì§ =================
        let curDate = new Date();
        let currentAction = null;
        let targetIndex = null;
        let html5QrcodeScanner = null;

        function initUI() { renderHome(); renderCalendar(); renderQuotesList(); renderVoca(); renderStats(); }
        
        function switchAuthMode(mode) {
            document.getElementById('login-form').style.display = mode === 'signup' ? 'none' : 'block';
            document.getElementById('signup-form').style.display = mode === 'signup' ? 'block' : 'none';
        }

        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            if(id === 'calendar') renderCalendar();
            if(id === 'voca') renderVoca();
            if(id === 'stats') renderStats();
        }

        function getCoverHtml(url, title) {
            if (!url || url.includes('placeholder') || url === 'undefined') {
                return `<div class="placeholder-cover" style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center; text-align:center; padding:5px; font-size:0.8rem; color:#555; border-radius:4px; font-weight:bold;">${title}</div>`;
            }
            return `<img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">`;
        }

        // ìŠ¤íŠ¸ë¦­ ë™ê¸°í™”
        function updateLogs() {
            let activeDates = new Set();
            window.db.reading.forEach(b => {
                if(b.startDate) activeDates.add(b.startDate);
                if(b.lastDate) activeDates.add(b.lastDate);
            });
            window.db.library.forEach(b => {
                if(b.date) activeDates.add(b.date);
            });
            window.db.logs = Array.from(activeDates);
        }

        window.resetToday = async () => {
            const today = new Date().toISOString().split('T')[0];
            if(confirm("ì˜¤ëŠ˜ ê¸°ë¡í•œ ëª¨ë“  ë…ì„œ ë‚´ì—­(í˜ì´ì§€ ê°±ì‹ , ì™„ë…)ì„ ì·¨ì†Œí• ê¹Œìš”?")) {
                for(let i = db.library.length - 1; i >= 0; i--) {
                    if(db.library[i].date === today) {
                        let b = db.library.splice(i, 1)[0];
                        b.date = null;
                        db.reading.push(b);
                    }
                }
                db.reading.forEach(b => {
                    if(b.lastDate === today || b.startDate === today) {
                        b.lastDate = null;
                        b.current = 0; 
                    }
                });
                updateLogs();
                await window.save();
                renderHome(); renderCalendar();
                alert("ì˜¤ëŠ˜ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        window.resetAll = async () => {
            if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ ê³„ì •ì˜ ë°ì´í„°ë§Œ ì§€ì›Œì§‘ë‹ˆë‹¤)')) {
                if(confirm('ì •ë§ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                    window.db = { reading: [], library: [], wish: [], toread: [], quotes: [], logs: [], voca: [] };
                    await window.save(); 
                    location.reload();   
                }
            }
        }

        // ë°”ì½”ë“œ
        function openScanner() {
            document.getElementById('scannerModal').style.display = 'flex';
            if(!html5QrcodeScanner) { html5QrcodeScanner = new Html5Qrcode("scanner-container"); }
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess);
        }
        function onScanSuccess(decodedText) { closeScanner(); document.getElementById('searchInput').value = decodedText; openSearch(); searchBooks(); }
        function closeScanner() {
            if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => document.getElementById('scannerModal').style.display = 'none').catch(console.log);
            else document.getElementById('scannerModal').style.display = 'none';
        }

        // ëª¨ë‹¬ì°½ ë„ìš°ê¸° (ê¸°ë¡/ì™„ë…/ìˆ˜ì •)
        window.openDateModal = function(action, index) {
            currentAction = action; targetIndex = index;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            document.getElementById('dateModal').style.display = 'flex';
            
            const pageWrap = document.getElementById('pageInputWrap');
            const extraEditWrap = document.getElementById('extraEditWrap');
            const commentInput = document.getElementById('bookComment');
            const title = document.getElementById('dateModalTitle');
            const delBtn = document.getElementById('btnDeleteBook');
            
            delBtn.style.display = 'none';
            extraEditWrap.style.display = 'none';
            commentInput.style.display = 'none';

            if (action === 'start_reading_search' || action === 'start_reading_toread') {
                pageWrap.style.display = 'none';
                title.innerText = 'ì‹œì‘ ë‚ ì§œ';
            } else if (action === 'record' || action === 'edit_reading') {
                pageWrap.style.display = 'block';
                title.innerText = action === 'record' ? 'ë…ì„œ ê¸°ë¡' : 'ê¸°ë¡ ìˆ˜ì •';
                document.getElementById('pageInput').value = db.reading[index].current;
                if(db.reading[index].lastDate) document.getElementById('dateInput').value = db.reading[index].lastDate;
            } else if (action === 'edit_library') {
                pageWrap.style.display = 'none';
                title.innerText = 'ì™„ë… ì •ë³´ ìˆ˜ì •';
                document.getElementById('dateInput').value = db.library[index].date;
                delBtn.style.display = 'block';
                extraEditWrap.style.display = 'block';
                document.getElementById('editPublisher').value = db.library[index].publisher || 'ë¯¸ìƒ';
                document.getElementById('editCategory').value = db.library[index].category || 'ê¸°íƒ€';
                commentInput.style.display = 'block';
                commentInput.value = db.library[index].comment || '';
            } else if (action === 'finish') {
                pageWrap.style.display = 'none';
                title.innerText = 'ì™„ë… ê¸°ë¡';
                commentInput.style.display = 'block';
                commentInput.value = '';
            }
        }

        window.confirmDateAction = function() {
            const date = document.getElementById('dateInput').value;
            if(!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

            if(currentAction === 'start_reading_search') {
                window.tempBookData.startDate = date;
                db.reading.push(window.tempBookData);
                window.tempBookData = null;
            } 
            else if(currentAction === 'start_reading_toread') {
                const b = db.toread[targetIndex];
                b.startDate = date;
                db.reading.push(b);
                db.toread.splice(targetIndex, 1);
            }
            else if(currentAction === 'record' || currentAction === 'edit_reading') {
                const page = document.getElementById('pageInput').value;
                db.reading[targetIndex].current = Math.min(parseInt(page), db.reading[targetIndex].total);
                db.reading[targetIndex].lastDate = date; 
            } 
            else if(currentAction === 'edit_library') {
                db.library[targetIndex].date = date;
                db.library[targetIndex].publisher = document.getElementById('editPublisher').value;
                db.library[targetIndex].category = document.getElementById('editCategory').value;
                db.library[targetIndex].comment = document.getElementById('bookComment').value.trim();
            } 
            else if(currentAction === 'finish') {
                const b = db.reading[targetIndex]; 
                b.date = date;
                b.comment = document.getElementById('bookComment').value.trim();
                db.library.push(b); 
                db.reading.splice(targetIndex, 1);
            }
            
            updateLogs();
            db.library.sort((a,b) => new Date(a.date) - new Date(b.date));
            window.save().then(() => { renderHome(); renderCalendar(); renderStats(); });
            document.getElementById('dateModal').style.display = 'none';
        }

        window.deleteCurrentBook = function() {
            if(confirm("ì •ë§ ì´ ì±…ì„ ì„œì¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                db.library.splice(targetIndex, 1);
                updateLogs();
                window.save().then(() => { renderHome(); renderCalendar(); renderStats(); });
                document.getElementById('dateModal').style.display = 'none';
            }
        }

        // ì±… ìƒì„¸ ì •ë³´ (ì½”ë©˜íŠ¸ íŒì—…)
        window.showBookDetail = function(index) {
            const b = db.library[index];
            const container = document.getElementById('bdCoverContainer');
            container.innerHTML = `<div style="width:120px; height:180px; margin:0 auto 15px; box-shadow:2px 2px 8px rgba(0,0,0,0.15);">${getCoverHtml(b.cover, b.title)}</div>`;
            
            document.getElementById('bdTitle').innerText = b.title;
            document.getElementById('bdInfo').innerText = `${b.author} | ${b.publisher}`;
            document.getElementById('bdDate').innerText = `ì™„ë…ì¼: ${b.date}`;
            
            const commentWrap = document.getElementById('bdCommentWrap');
            const commentBox = document.getElementById('bdComment');
            
            if(b.comment && b.comment.length > 0) {
                commentWrap.style.display = 'block';
                commentBox.innerText = b.comment;
            } else {
                commentWrap.style.display = 'none';
            }
            
            document.getElementById('bookDetailModal').style.display = 'flex';
        }

        // ë Œë”ë§
        function renderHome() {
            const weekDiv = document.getElementById('weekCircles'); weekDiv.innerHTML = '';
            const today = new Date(); const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay());
            let streak = db.logs.includes(today.toISOString().split('T')[0]) ? 1 : 0;
            document.getElementById('streakDisplay').innerText = streak ? "ğŸ”¥ ì˜¤ëŠ˜ ë…ì„œ ì™„ë£Œ!" : "ğŸ“š ì˜¤ëŠ˜ ì±…ì„ ì½ì–´ë³´ì„¸ìš”";
            for(let i=0; i<7; i++) {
                const d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i);
                const dStr = d.toISOString().split('T')[0];
                const isDone = db.logs.includes(dStr);
                weekDiv.innerHTML += `<div><div class="day-circle ${isDone?'active':''}">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][i]}</div><div class="day-label">${d.getDate()}</div></div>`;
            }
            const rDiv = document.getElementById('readingList'); rDiv.innerHTML = '';
            if(db.reading.length===0) rDiv.innerHTML='<div style="padding:10px; color:#999; font-size:0.9rem;">ì½ê³  ìˆëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            db.reading.forEach((b, i) => {
                const pct = Math.round((b.current / b.total) * 100);
                const coverHtml = getCoverHtml(b.cover, b.title);
                rDiv.innerHTML += `<div class="reading-card"><button class="btn-card-close" onclick="delReading(${i})">Ã—</button><div style="width:60px; height:90px; flex-shrink:0;">${coverHtml}</div><div style="flex:1; margin-left:15px;"><div style="font-weight:bold; font-size:0.95rem; margin-bottom:5px;">${b.title}</div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div style="font-size:0.8rem; color:#888; margin-top:8px; display:flex; align-items:center; justify-content:space-between;"><span>${pct}% (${b.current}p)</span><div><button class="btn-round btn-record" onclick="openDateModal('record', ${i})">ê¸°ë¡</button><button class="btn-round btn-edit" onclick="openDateModal('edit_reading', ${i})">ìˆ˜ì •</button><button class="btn-round btn-finish" onclick="openDateModal('finish', ${i})">ì™„ë…</button></div></div></div></div>`;
            });
            renderMiniList(db.wish, 'wishList', 'wish'); renderMiniList(db.toread, 'toreadList', 'toread');
            document.getElementById('wishCount').innerText=db.wish.length+'ê¶Œ'; document.getElementById('toreadCount').innerText=db.toread.length+'ê¶Œ';
            
            const shelf = document.getElementById('bookShelf'); shelf.innerHTML = '';
            if(db.library.length===0) shelf.innerHTML = '<div style="width:100%; text-align:center; padding:30px; color:rgba(255,255,255,0.5);">ì„œì¬ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';
            else db.library.forEach((b, i) => {
                const w=Math.min(65, Math.max(30, b.total/10)); const h=Math.min(160, Math.max(120, 120+(b.total%40)));
                const hue=Math.floor(Math.random()*30)+10;
                shelf.innerHTML += `<div class="spine" style="background:hsl(${hue},40%,40%); width:${w}px; height:${h}px;" title="${b.title}" onclick="showBookDetail(${i})">${b.title}</div>`;
            });
        }
        
        function renderMiniList(l,id,t) {
            const el=document.getElementById(id); el.innerHTML=''; if(l.length===0) {el.innerHTML='<div style="padding:10px; color:#999; font-size:0.8rem;">ë¹„ì–´ìˆìŒ</div>'; return;}
            l.forEach((b,i)=>{
                const cv=getCoverHtml(b.cover,b.title).replace('style="','style="border-radius:5px;');
                el.innerHTML+=`<div class="mini-card"><button class="btn-mini-del" onclick="delMini('${t}',${i})">Ã—</button><div style="width:90px; height:130px; margin:0 auto; box-shadow:2px 2px 5px rgba(0,0,0,0.1);">${cv}</div><div class="mini-title">${b.title}</div>${t==='wish'?`<button onclick="moveWishToToread(${i})" style="font-size:0.7rem; margin-top:2px; background:#f5f5f5; border:1px solid #ddd; border-radius:3px; cursor:pointer;">â–¼ ì˜ˆì • ì´ë™</button>`:`<button onclick="openDateModal('start_reading_toread', ${i})" style="font-size:0.7rem; margin-top:2px; background:#e3f2fd; border:none; border-radius:3px; cursor:pointer;">â–¶ ì½ê¸° ì‹œì‘</button>`}</div>`;
            });
        }
        
        window.openSearch = function() { document.getElementById('searchModal').style.display='block'; document.getElementById('searchInput').focus(); }
        window.searchBooks = async function() {
            let q = document.getElementById('searchInput').value.trim(); 
            if(!q) return;
            const list = document.getElementById('searchResultList'); list.innerHTML = 'ê²€ìƒ‰ì¤‘...';
            try {
                let isBarcode = /^\d{10,13}$/.test(q);
                let apiQuery = isBarcode ? `isbn:${q}` : encodeURIComponent(q);
                let res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${apiQuery}&langRestrict=ko&maxResults=15&key=${window.API_KEY}`);
                let data = await res.json();
                if (isBarcode && (!data.items || data.items.length === 0)) {
                    res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&langRestrict=ko&maxResults=15&key=${window.API_KEY}`);
                    data = await res.json();
                }
                list.innerHTML = '';
                if(!data.items || data.items.length === 0) { 
                    if (isBarcode) list.innerHTML = '<div style="padding:20px; text-align:center; color:#d84315; line-height:1.5;">êµ¬ê¸€ ë„ì„œì— ë“±ë¡ë˜ì§€ ì•Šì€ ë°”ì½”ë“œì…ë‹ˆë‹¤.<br><strong>ìœ„ ê²€ìƒ‰ì°½ì— ì±… ì œëª©ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ì£¼ì„¸ìš”!</strong></div>';
                    else list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
                    return; 
                }
                data.items.forEach(item => {
                    const i = item.volumeInfo; if((i.categories||[]).some(c=>/Comic|Manga|ë§Œí™”/i.test(c))) return;
                    const b = { title: i.title, author: i.authors?i.authors[0]:'ë¯¸ìƒ', publisher: i.publisher||'ë¯¸ìƒ', cover: i.imageLinks?i.imageLinks.thumbnail:'', total: i.pageCount||300, category: translateCat((i.categories||[])[0]||'ê¸°íƒ€'), current: 0 };
                    const bStr = JSON.stringify(b).replace(/"/g, '&quot;');
                    let img = getCoverHtml(b.cover, b.title);
                    list.innerHTML += `<div class="result-item"><div style="width:60px; height:90px; flex-shrink:0;">${img}</div><div style="flex:1;"><div style="font-weight:bold;">${b.title}</div><div style="font-size:0.8rem; color:#666;">${b.author} | ${b.publisher} | ${b.category}</div><div class="result-actions" style="margin-top:10px;"><button onclick='addBook("reading",${bStr})' style="background:var(--accent-color); color:white;">ì½ê¸°</button><button onclick='addBook("wish",${bStr})' style="background:#ffcc80;">ìœ„ì‹œ</button><button onclick='addBook("toread",${bStr})' style="background:#bbdefb;">ì˜ˆì •</button></div></div></div>`;
                });
            } catch(e) { list.innerHTML = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; }
        }

        function translateCat(eng) { if(/[ê°€-í£]/.test(eng)) return eng; const map={'Fiction':'ì†Œì„¤','Novel':'ì†Œì„¤','Poetry':'ì‹œ','History':'ì—­ì‚¬','Science':'ê³¼í•™','Business':'ê²½ì œê²½ì˜','Self-Help':'ìê¸°ê³„ë°œ','Essay':'ì—ì„¸ì´'}; for(let k in map) if(new RegExp(k,'i').test(eng)) return map[k]; return 'ê¸°íƒ€'; }
        
        window.addBook = function(type, book) {
            if(type === 'reading') {
                window.tempBookData = book;
                document.getElementById('searchModal').style.display='none';
                openDateModal('start_reading_search', null);
            } else { 
                db[type].push(book); window.save().then(() => { renderHome(); document.getElementById('searchModal').style.display='none'; alert('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!'); }); 
            }
        }
        
        window.delReading = function(i) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db.reading.splice(i,1); updateLogs(); window.save().then(()=>renderHome()); } }
        window.dropReading = function(i) { if(confirm('í•˜ì°¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db.reading.splice(i,1); updateLogs(); window.save().then(()=>renderHome()); } }
        window.delMini = function(t, i) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { db[t].splice(i,1); updateLogs(); window.save().then(()=>renderHome()); } }
        window.moveWishToToread = function(i) { db.toread.push(db.wish[i]); db.wish.splice(i,1); window.save().then(()=>renderHome()); }

        // ë‹¬ë ¥
        function renderCalendar() {
            const grid = document.getElementById('calGrid'); grid.innerHTML = '';
            ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>grid.innerHTML+=`<div style="text-align:center; padding:5px; font-weight:bold; font-size:0.8rem;">${d}</div>`);
            const y=curDate.getFullYear(), m=curDate.getMonth();
            document.getElementById('calTitle').innerText = `${y}. ${m+1}`;
            const first=new Date(y,m,1).getDay(), last=new Date(y,m+1,0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML+='<div></div>';
            for(let d=1; d<=last; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const books = [...db.library.filter(x=>x.date===dStr), ...db.reading.filter(x=>x.startDate===dStr||x.lastDate===dStr)];
                let html=`<div class="cal-day"><div class="cal-num" style="color:${new Date(y,m,d).getDay()===0?'red':'inherit'}">${d}</div>`;
                if(books.length>0) {
                    const uniq = [...new Map(books.map(i => [i['title'], i])).values()];
                    uniq.slice(0,3).forEach(b => {
                        let img = getCoverHtml(b.cover, b.title).replace('style="', 'style="border-radius:0;'); 
                        html += `<div class="cal-split">${img}</div>`;
                    });
                }
                html+='</div>'; grid.innerHTML+=html;
            }
            const gal = document.getElementById('galleryGrid'); gal.innerHTML = '';
            for(let i=db.library.length-1; i>=0; i--) {
                const b = db.library[i]; let img = getCoverHtml(b.cover, b.title);
                gal.innerHTML += `
                    <div class="gallery-item">
                        <button class="btn-gal-edit" onclick="openDateModal('edit_library', ${i})">âœï¸</button>
                        <div style="width:100%; height:140px; margin-bottom:5px; box-shadow:2px 2px 5px rgba(0,0,0,0.1); cursor:pointer;" onclick="showBookDetail(${i})">${img}</div>
                        <div class="gallery-title">${b.title}</div>
                        <div class="gallery-author">${b.author}</div>
                        <div class="gallery-date">${b.date}</div>
                    </div>`;
            }
        }
        window.changeMonth = function(n) { curDate.setMonth(curDate.getMonth()+n); renderCalendar(); }

        // ë¬¸ì¥
        window.toggleQuoteView = function(mode) {
            document.getElementById('quoteMainView').style.display = mode==='list'?'none':'block';
            document.getElementById('quoteListView').style.display = mode==='list'?'block':'none';
            if(mode==='list') renderQuotesList();
        }
        
        window.openQuoteModal = function() {
            const sel = document.getElementById('qBook'); sel.innerHTML = '<option value="">ì±… ì„ íƒ</option>';
            
            if (db.reading.length > 0) {
                const g1 = document.createElement('optgroup'); g1.label = "ğŸ“– ì½ê³  ìˆëŠ” ì±…";
                db.reading.forEach(b => {
                    const op=document.createElement('option'); op.value=b.title; op.innerText=b.title; op.dataset.cover=b.cover; op.dataset.author=b.author; g1.appendChild(op);
                });
                sel.appendChild(g1);
            }
            if (db.library.length > 0) {
                const g2 = document.createElement('optgroup'); g2.label = "ğŸ“š ì™„ë…í•œ ì±…";
                db.library.forEach(b => {
                    const op=document.createElement('option'); op.value=b.title; op.innerText=b.title; op.dataset.cover=b.cover; op.dataset.author=b.author; g2.appendChild(op);
                });
                sel.appendChild(g2);
            }

            document.getElementById('quoteModal').style.display = 'flex';
        }

        window.saveQuote = function() {
            const s=document.getElementById('qBook'), t=document.getElementById('qText').value, p=document.getElementById('qPage').value;
            if(!s.value || !t) return alert('ì…ë ¥í•´ì£¼ì„¸ìš”!');
            const opt = s.options[s.selectedIndex];
            db.quotes.push({ book:s.value, page:p, text:t, cover:opt.dataset.cover, author:opt.dataset.author });
            window.save().then(() => { toggleQuoteView('list'); document.getElementById('quoteModal').style.display='none'; });
        }
        function renderQuotesList() {
            const l=document.getElementById('quoteList'); l.innerHTML='';
            db.quotes.slice().reverse().forEach(q => {
                l.innerHTML += `<div class="quote-item"><div style="font-family:'RIDIBatang'; font-size:1.05rem; line-height:1.5;">"${q.text}"</div><div style="text-align:right; font-size:0.8rem; color:#888; margin-top:10px;"><span style="font-weight:bold;">${q.book}</span> - ${q.author||'ë¯¸ìƒ'} (p.${q.page})</div></div>`;
            });
        }
        window.openMysteryModal = function() {
            if(db.quotes.length===0) return alert('ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤!');
            const g=document.getElementById('mysteryGrid'); g.innerHTML='';
            [...db.quotes].sort(()=>Math.random()-0.5).forEach(q=>{
                const c=document.createElement('div'); c.className='mystery-card'; c.innerHTML=`<div class="mystery-card-text">"${q.text}"</div>`;
                c.onclick=()=>showQuoteDetailQuoteMode(q); g.appendChild(c);
            });
            document.getElementById('mysteryModal').style.display='flex';
        }
        
        window.showQuoteDetailQuoteMode = function(q) {
            let c = q.cover, a = q.author;
            if(!c || c.includes('placeholder') || c === 'undefined') {
                const f = [...db.library, ...db.reading].find(b => b.title === q.book);
                if(f) { c = f.cover; a = f.author; }
            }
            const ct = document.getElementById('qdCoverContainer');
            ct.innerHTML = `<div style="width:100px; height:150px; margin:0 auto 15px; box-shadow:2px 2px 8px rgba(0,0,0,0.15);">${getCoverHtml(c, q.book)}</div>`;
            document.getElementById('qdTitle').innerText = q.book;
            document.getElementById('qdAuthor').innerText = a||'ë¯¸ìƒ';
            document.getElementById('qdText').innerText = q.text;
            document.getElementById('qdPage').innerText = q.page||'?';
            document.getElementById('quoteDetailModal').style.display = 'flex';
        }

        // ë‹¨ì–´ì¥ (ìœ„í‚¤ íŒŒì‹± ìˆ˜ì • - ê¹”ë”í•˜ê²Œ)
        window.searchDict = async function() {
            const word = document.getElementById('vocaWordInput').value.trim();
            if(!word) return alert("ë‹¨ì–´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            const btn = document.getElementById('btnDictSearch');
            btn.innerHTML = "â³ ëœ» ì°¾ëŠ” ì¤‘...";
            
            try {
                const res = await fetch(`https://ko.wiktionary.org/w/api.php?action=query&prop=extracts&format=json&explaintext=1&titles=${encodeURIComponent(word)}&origin=*`);
                const data = await res.json();
                const pages = data.query.pages;
                const page = Object.values(pages)[0];
                
                if (page.pageid && page.extract) {
                    let text = page.extract;
                    // ìœ„í‚¤ ê¸°í˜¸(== ì–´ì› ==, === ëª…ì‚¬ === ë“±) ì œê±°
                    text = text.replace(/=+.*?=+/g, '');
                    // ì•ë’¤ ê³µë°± ë° ë¹ˆ ì¤„ ì œê±°
                    text = text.replace(/^\s*[\r\n]/gm, '').trim();
                    
                    if(text) {
                        document.getElementById('vocaMeaningInput').value = text;
                    } else {
                        alert("ì‚¬ì „ì— ëœ»ì´ ëª…í™•í•˜ê²Œ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ì ì–´ì£¼ì„¸ìš”!");
                    }
                } else {
                    alert("ì‚¬ì „ì—ì„œ ë‹¨ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì ì–´ì£¼ì„¸ìš”!");
                }
            } catch(e) {
                alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
            btn.innerHTML = "<span>ğŸ¤–</span> AI ìë™ ëœ» ì°¾ê¸°";
        }

        window.addVoca = function() {
            const word = document.getElementById('vocaWordInput').value.trim();
            const meaning = document.getElementById('vocaMeaningInput').value.trim();
            if(!word || !meaning) return alert("ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            if(!db.voca) db.voca = [];
            db.voca.push({ word, meaning, date: new Date().toISOString() });
            
            window.save().then(() => {
                document.getElementById('vocaWordInput').value = '';
                document.getElementById('vocaMeaningInput').value = '';
                renderVoca();
                alert("ë‹¨ì–´ì¥ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            });
        }

        window.deleteVoca = function(index) {
            if(confirm("ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                db.voca.splice(index, 1);
                window.save().then(() => renderVoca());
            }
        }

        window.renderVoca = function() {
            const container = document.getElementById('vocaListContainer');
            const sortType = document.getElementById('vocaSortSelect').value;
            container.innerHTML = '';

            if(!db.voca || db.voca.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ë‹¨ì–´ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let vocaList = [...db.voca].map((v, i) => ({...v, originalIndex: i}));
            if(sortType === 'abc') vocaList.sort((a,b) => a.word.localeCompare(b.word, 'ko-KR'));
            else vocaList.reverse();

            vocaList.forEach(v => {
                container.innerHTML += `
                    <div class="voca-card">
                        <button class="btn-voca-del" onclick="deleteVoca(${v.originalIndex})">Ã—</button>
                        <div class="voca-word">${v.word}</div>
                        <div class="voca-meaning">${v.meaning.replace(/\n/g, '<br>')}</div>
                    </div>`;
            });
        }

        // ë­í‚¹
        function renderStats() {
            const c={}, a={}, p={}; 
            db.library.forEach(b=>{ 
                const sc = b.category || translateCat(b.category); 
                c[sc]=(c[sc]||0)+1; 
                a[b.author]=(a[b.author]||0)+1; 
                p[b.publisher]=(p[b.publisher]||0)+1; 
            });
            drawBarChart('rankCategory',c); drawBarChart('rankAuthor',a); drawBarChart('rankPublisher',p);
        }
        function drawBarChart(id,d) {
            const el=document.getElementById(id); el.innerHTML=''; const s=Object.entries(d).sort((a,b)=>b[1]-a[1]).slice(0,5);
            if(s.length===0) {el.innerHTML='<div style="color:#ccc; text-align:center;">ë°ì´í„° ì—†ìŒ</div>'; return;}
            const max=s[0][1]; const m=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4.','5.'];
            s.forEach((v,i)=> el.innerHTML+=`<div class="rank-row"><div class="rank-info"><span>${m[i]} ${v[0]}</span><span style="font-weight:bold; color:var(--primary-color)">${v[1]}ê¶Œ</span></div><div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${(v[1]/max)*100}%"></div></div></div>`);
        }
    </script>
</body>
</html>